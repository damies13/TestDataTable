---
name: Regression Tests

on: push

jobs:
  Agent:
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
        # python: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']
        python: ['3.7']
      fail-fast: false
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: "Apt Update"
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        run: |
          sudo apt update -y
      - name: "Apt Upgrade"
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        run: |
          sudo apt upgrade -y
      - name: "Ubuntu Installs"
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        run: |
          sudo apt install -y scrot fluxbox
          sudo apt list --installed
      - name: Installs prerequisits for Browser Library
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        run: |
          # files needed for Browser Library Webkit
          sudo apt install libgtk-3-0 libnss3 libasound2 libgbm-dev
          sudo apt install -y gstreamer1.0-libav libnss3-tools libatk-bridge2.0-0 libcups2-dev libxkbcommon-x11-0 libxcomposite-dev libxrandr2

      - name: "Ubuntu Xvfb"
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        run: |
          export DISPLAY=:13.0
          Xvfb :13 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          # xauth with complain unless ~/.Xauthority exists
          touch ~/.Xauthority
          # To view a listing of the .Xauthority file, enter the following
          xauth list
          sleep 1
          # fluxbox
          fluxbox &

      - name: Install NodeJS for Browser Library
        uses: actions/setup-node@v4

      - name: Install Pip Requirements
        run: pip install -r Regression_Tests/pip_requirements.txt

      - name: Run rfbrowser init for Browser Library
        run: rfbrowser init

      - name: Robot Framework
        run: pabot --outputdir Regression_Tests/Logs/${{ matrix.platform }}_${{ matrix.python }} -v STT_MIN:1 -v STT_MAX:5 Regression_Tests
        env:
          DISPLAY: :13.0

      - name: Archive Agent Logs
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: Regression_Tests-${{ matrix.platform }}-${{ matrix.python }}
          path: Regression_Tests/Logs/${{ matrix.platform }}_${{ matrix.python }}
          retention-days: 15

      - name: Archive Agent Logs (longer retention if failed)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: Regression_Tests-${{ matrix.platform }}-${{ matrix.python }}
          path: Regression_Tests/Logs/${{ matrix.platform }}_${{ matrix.python }}
          retention-days: 90
